/*
 * dnssecjava - a DNSSEC validating stub resolver for Java
 * Copyright (C) 2013 Ingo Bauersachs. All rights reserved.
 *
 * This file is part of dnssecjava.
 *
 * Dnssecjava is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * Dnssecjava is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with dnssecjava.  If not, see <http://www.gnu.org/licenses/>.
 */

package org.jitsi.dnssec;

import static org.junit.Assert.*;

import java.io.IOException;

import org.junit.Test;
import org.xbill.DNS.Flags;
import org.xbill.DNS.Message;
import org.xbill.DNS.Rcode;

public class TestWildcard extends TestBase {
    @Test
    public void testNameNotExpandedFromWildcardWhenNonWildcardExists() throws IOException {
//        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 60176
//        ;; flags: qr aa rd ra ; qd: 1 an: 2 au: 4 ad: 3 
//        ;; QUESTIONS:
//        ;;  a.d.ingotronic.ch., type = A, class = IN
//
//        ;; ANSWERS:
//        a.d.ingotronic.ch.  300 IN  A   127.0.0.2
//        a.d.ingotronic.ch.  300 IN  RRSIG   A 5 3 300 20130531135453 20130501134258 17430 ingotronic.ch. IZWwjIZi58dHBY9/ui7O1NsRJzSBG9LuwkQ+AEnzLjTtZzRgVJAhDJj2XijEXyMsV0hoNNXWWoDdOLRgbN4w5/tLDaBZD2M1dyvNlamRdb49x0G1TJq1uiXR7a1t0PN6c9keUDRteA84VwqAXbiCWnutWVOiNQ16tH0LkgjK5uc=
//
//        ;; AUTHORITY RECORDS:
//        ingotronic.ch.      300 IN  NS  ns1.ingotronic.ch.
//        ingotronic.ch.      300 IN  RRSIG   NS 5 2 300 20130531140553 20130501134258 17430 ingotronic.ch. d5muom+0sQUrxRSo8lI1n2rT4XG7PP3WqZxpwXZWejRHwJsWyjYIrQq6K59GKfS116oQoRs3sdav4/Ujb3Cqkq8T5/Wj38mvqSOanakly6P6K7bMOCS1zPZ95QgdyxDsQH3nDHRWUmDSl/NSCkSVWiBTMBtFwgmIUiMB+HCV/fk=
//        a.d.ingotronic.ch.  300 IN  NSEC    invalid.ingotronic.ch. A RRSIG NSEC
//        a.d.ingotronic.ch.  300 IN  RRSIG   NSEC 5 4 300 20130531135453 20130501134258 17430 ingotronic.ch. LsXsCIWEqG2pAtx+I/rfrlP2ToAhl9D0VcE01kd/Dcu+GSrashuMdziJi0bKgzFVUHLEM4TMSwopyy1u9eSb3xPfLAwsrXsJB3Kx3Kiz2lVn95RliUlgzgLnxN5Vr95kBxGV0yqQkB+bWsVUdJpZCoYMWd1KUJJ4m51ZtmKjScY=
//
//        ;; ADDITIONAL RECORDS:
//        ns1.ingotronic.ch.  300 IN  A   62.192.5.131
//        ns1.ingotronic.ch.  300 IN  RRSIG   A 5 3 300 20130531140814 20130501134258 17430 ingotronic.ch. A86YmGMp/CQZfvbhXRMIrVbQwIGz1iSWEAMbV4XgeHIvAM00TJmbpvQnekhmffEBYeokTf4lvVSIBfQ+t6GcHT583CMZ0ecfmEJhgei8H9ON85OFtl/59YCUO+Ew6R1T8hrDG3R5P/vP0OuVfNna1WRJZ1ighvoqpghZu7kXgRQ=
//        .           32768   CLASS4096   OPT  ; payload 4096, xrcode 0, version 0, flags 32768
//
//        ;; Message size: 833 bytes
        //this a faked response: the original query/response was for b.d.ingotronic.ch. and is now changed to a.d.ingotronic.ch.
        add("a.d.ingotronic.ch./A",
                "EB1085800001000200040003016101640A696E676F74726F6E69630263680000010001C00C000100010000012C00047F000002C00C002E00010000012C00A1000105030000012C51A8ABAD51811BE244160A696E676F74726F6E6963026368002195B08C8662E7C747058F7FBA2ECED4DB112734811BD2EEC2443E0049F32E34ED6734605490210C98F65E28C45F232C57486834D5D65A80DD38B4606CDE30E7FB4B0DA0590F6335772BCD95A99175BE3DC741B54C9AB5BA25D1EDAD6DD0F37A73D91E50346D780F38570A805DB8825A7BAD5953A2350D7AB47D0B9208CAE6E7C010000200010000012C0006036E7331C010C010002E00010000012C00A1000205020000012C51A8AE4151811BE244160A696E676F74726F6E6963026368007799AEA26FB4B1052BC514A8F252359F6AD3E171BB3CFDD6A99C69C176567A3447C09B16CA3608AD0ABA2B9F4629F4B5D7AA10A11B37B1D6AFE3F5236F70AA92AF13E7F5A3DFC9AFA9239A9DA925CBA3FA2BB6CC3824B5CCF67DE5081DCB10EC407DE70C74565260D297F3520A44955A2053301B45C20988522301F87095FDF90161C00E002F00010000012C001F07696E76616C69640A696E676F74726F6E6963026368000006400000000003C19F002E00010000012C00A1002F05040000012C51A8ABAD51811BE244160A696E676F74726F6E6963026368002EC5EC088584A86DA902DC7E23FADFAE53F64E802197D0F455C134D6477F0DCBBE192ADAB21B8C7738898B46CA8331555072C43384CC4B0A29CB2D6EF5E49BDF13DF2C0C2CAD7B090772B1DCA8B3DA5567F79465894960CE02E7C4DE55AFDE64071195D32A90901F9B5AC554749A590A860C59DD4A5092789B9D59B662A349C6C0EC000100010000012C00043EC00583C0EC002E00010000012C00A1000105030000012C51A8AECE51811BE244160A696E676F74726F6E69630263680003CE98986329FC24197EF6E15D1308AD56D0C081B3D6249610031B5785E078722F00CD344C999BA6F4277A48667DF10161EA244DFE25BD548805F43EB7A19C1D3E7CDC2319D1E71F98426181E8BC1FD38DF39385B65FF9F580943BE130E91D53F21AC31B74793FFBCFD0EB957CD9DAD564496758A086FA2AA60859BBB91781140000291000000080000000");
//                                         ^^

        // a.d.ingotronic.ch./A exists, but the response is faked from *.d.ingotronic.ch. which must be detected by the NSEC proof
        Message response = resolver.send(createMessage("a.d.ingotronic.ch./A"));
        assertFalse(response.getHeader().getFlag(Flags.AD));
        assertEquals(Rcode.SERVFAIL, response.getHeader().getRcode());
    }

    @Test
    public void testNameNotExpandedFromWildcardWhenNonWildcardExistsNsec3() throws IOException {
//        ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36879
//        ;; flags: qr aa rd ra ; qd: 1 an: 2 au: 4 ad: 3 
//        ;; QUESTIONS:
//        ;;  a.d.nsec3.ingotronic.ch., type = A, class = IN
//
//        ;; ANSWERS:
//        a.d.nsec3.ingotronic.ch.    300 IN  A   127.0.0.1
//        a.d.nsec3.ingotronic.ch.    300 IN  RRSIG   A 7 4 300 20130531144246 20130501134258 62417 nsec3.ingotronic.ch. c1tuhkJ26CMCEEpFLJyDiILxad6Yd0NkVKRlYlbAlE7ud094ram1b2Lb7RIXEaffJlHiY3PA24AGzHEvaZuQODnW5z9SlON+gTeaLE8AhuZWhcp3BjTj4Z3RUykQtGSWWtJNkPktxnu0RoXTpwxYJby2iZXa/lGcCkd+cgfb9GQ=
//
//        ;; AUTHORITY RECORDS:
//        nsec3.ingotronic.ch.    300 IN  NS  ns1.ingotronic.ch.
//        nsec3.ingotronic.ch.    300 IN  RRSIG   NS 7 3 300 20130531134545 20130501134258 62417 nsec3.ingotronic.ch. EPF3Z6tqJIfmIKpkcN806UtqMeYHSKLMU+BN/UTk+hw1y/kHy77Jfj0XdyqM3JcEGRTqxaMybdjQZ0hNmOam7oECCZY8VHw6qutD5cxGouvpWLib3Mw0aF+TZ2QraOpiGogD3VAQvqyk+faIBAhMw1FGtYcHE+6rib3iWWrs9GU=
//        a.d.nsec3.ingotronic.ch.    300 IN  NSEC    www.nsec3.ingotronic.ch. A RRSIG NSEC
//        a.d.nsec3.ingotronic.ch.    300 IN  RRSIG   NSEC 7 5 300 20130531144246 20130501134258 62417 nsec3.ingotronic.ch. bBqy5dPwDim8Q+RrMjmjHwAe25WGES/YmuoJIwAukluxW7uZ7thP3dEOxdBj4b7D7pzSHm39l89UQGOiX9iBOLBiOu5amVoXUlWwEYnXe8SCMW39ohTBipMvlPcGFjRabALZta7Vijwl1ZG0DIW2nUdneqAw6tQp4ue73Fy9JXY=
//
//        ;; ADDITIONAL RECORDS:
//        ns1.ingotronic.ch.  300 IN  A   62.192.5.131
//        ns1.ingotronic.ch.  300 IN  RRSIG   A 5 3 300 20130531140814 20130501134258 17430 ingotronic.ch. A86YmGMp/CQZfvbhXRMIrVbQwIGz1iSWEAMbV4XgeHIvAM00TJmbpvQnekhmffEBYeokTf4lvVSIBfQ+t6GcHT583CMZ0ecfmEJhgei8H9ON85OFtl/59YCUO+Ew6R1T8hrDG3R5P/vP0OuVfNna1WRJZ1ighvoqpghZu7kXgRQ=
//        .           32768   CLASS4096   OPT  ; payload 4096, xrcode 0, version 0, flags 32768
//
//        ;; Message size: 859 bytes
        //this a faked response: the original query/response was for b.d.nsec3.ingotronic.ch. and is now changed to a.d.nsec3.ingotronic.ch.
        add("a.d.nsec3.ingotronic.ch./A",
                "900F8580000100020004000301610164056E736563330A696E676F74726F6E69630263680000010001C00C000100010000012C00047F000001C00C002E00010000012C00A7000107040000012C51A8B6E651811BE2F3D1056E736563330A696E676F74726F6E696302636800735B6E864276E82302104A452C9C838882F169DE9877436454A4656256C0944EEE774F78ADA9B56F62DBED121711A7DF2651E26373C0DB8006CC712F699B903839D6E73F5294E37E81379A2C4F0086E65685CA770634E3E19DD1532910B464965AD24D90F92DC67BB44685D3A70C5825BCB68995DAFE519C0A477E7207DBF464C010000200010000012C0006036E7331C016C010002E00010000012C00A7000207030000012C51A8A98951811BE2F3D1056E736563330A696E676F74726F6E69630263680010F17767AB6A2487E620AA6470DF34E94B6A31E60748A2CC53E04DFD44E4FA1C35CBF907CBBEC97E3D17772A8CDC97041914EAC5A3326DD8D067484D98E6A6EE810209963C547C3AAAEB43E5CC46A2EBE958B89BDCCC34685F9367642B68EA621A8803DD5010BEACA4F9F68804084CC35146B5870713EEAB89BDE2596AECF4650161C00E002F00010000012C002103777777056E736563330A696E676F74726F6E6963026368000006400000000003C1B1002E00010000012C00A7002F07050000012C51A8B6E651811BE2F3D1056E736563330A696E676F74726F6E6963026368006C1AB2E5D3F00E29BC43E46B3239A31F001EDB9586112FD89AEA0923002E925BB15BBB99EED84FDDD10EC5D063E1BEC3EE9CD21E6DFD97CF544063A25FD88138B0623AEE5A995A175255B01189D77BC482316DFDA214C18A932F94F70616345A6C02D9B5AED58A3C25D591B40C85B69D47677AA030EAD429E2E7BBDC5CBD2576C0F8000100010000012C00043EC00583C0F8002E00010000012C00A1000105030000012C51A8AECE51811BE244160A696E676F74726F6E69630263680003CE98986329FC24197EF6E15D1308AD56D0C081B3D6249610031B5785E078722F00CD344C999BA6F4277A48667DF10161EA244DFE25BD548805F43EB7A19C1D3E7CDC2319D1E71F98426181E8BC1FD38DF39385B65FF9F580943BE130E91D53F21AC31B74793FFBCFD0EB957CD9DAD564496758A086FA2AA60859BBB91781140000291000000080000000");
//                                         ^^

        // a.d.nsec3.ingotronic.ch./A exists, but the response is faked from *.d.nsec3.ingotronic.ch. which must be detected by the NSEC proof
        Message response = resolver.send(createMessage("a.d.nsec3.ingotronic.ch./A"));
        assertFalse(response.getHeader().getFlag(Flags.AD));
        assertEquals(Rcode.SERVFAIL, response.getHeader().getRcode());
    }
}
